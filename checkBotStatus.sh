#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

CONTAINER_NAME="recur_bot"

echo "================================================"
echo "üîç –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ë–û–¢–ê recur_bot"
echo "================================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${CONTAINER_NAME} –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${CONTAINER_NAME} –ù–ï –∑–∞–ø—É—â–µ–Ω"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: docker compose up -d"
    exit 1
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –õ–æ–≥–∏ —Å—Ç–∞—Ä—Ç–∞
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—Ç–∞..."
echo "---"
docker logs ${CONTAINER_NAME} --tail 50 2>&1 | grep -E "(–ó–∞–ø—É—Å—Ç–∏–ª—Å—è –∫–∞–∫|Bot commands registered|Reminder scheduler started)" || echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ª–æ–≥–∏"
echo "---"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥..."
if docker logs ${CONTAINER_NAME} --tail 100 2>&1 | grep -q "Bot commands registered"; then
    echo "‚úÖ –ö–æ–º–∞–Ω–¥—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:"
    docker logs ${CONTAINER_NAME} --tail 100 2>&1 | grep "Bot commands registered"
else
    echo "‚ö†Ô∏è –õ–æ–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞)"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π..."
if docker logs ${CONTAINER_NAME} --tail 100 2>&1 | grep -q "Reminder scheduler started"; then
    echo "‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω"
    # –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Ç–∏–∫–∞
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–∏–∫–∏:"
    docker logs ${CONTAINER_NAME} --tail 200 2>&1 | grep "üîÑ Tick" | tail -3
else
    echo "‚ùå –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ù–ï –∑–∞–ø—É—â–µ–Ω"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –û—à–∏–±–∫–∏
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)..."
ERRORS=$(docker logs ${CONTAINER_NAME} --tail 200 2>&1 | grep -i "error\|‚ùå" | tail -5)
if [ -z "$ERRORS" ]; then
    echo "‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏:"
    echo "$ERRORS"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥—ã /checknotifications
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ /checknotifications..."
if docker exec ${CONTAINER_NAME} grep -q "bot.command('checknotifications'" node.js 2>/dev/null; then
    echo "‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–¥–µ"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É)"
fi
echo ""

echo "================================================"
echo "üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
echo "================================================"
echo "1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /checknotifications –±–æ—Ç—É –≤—Ä—É—á–Ω—É—é"
echo "2. –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –≤ –º–µ–Ω—é - –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à Telegram:"
echo "   - –ú–æ–±–∏–ª—å–Ω—ã–π: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–∞–Ω–Ω—ã–µ ‚Üí –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"
echo "   - Desktop: –í—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞"
echo "3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ @BotFather"
echo "   /mybots ‚Üí [–≤–∞—à –±–æ—Ç] ‚Üí Edit Bot ‚Üí Edit Commands"
echo ""
echo "üìä –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
echo "   docker logs -f ${CONTAINER_NAME} | grep 'üîÑ Tick'"
echo ""
