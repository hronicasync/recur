# Recur Bot - Проект отслеживания рекурентных платежей

## Что это?

Telegram бот для отслеживания подписок и всех повторяющихся платежей. Помогает держать под контролем ежемесячные и ежегодные списания, напоминает о предстоящих оплатах и ведет историю платежей.

## Зачем?

Решаем проблему забытых подписок и неожиданных списаний. Бот:
- Напоминает о предстоящих платежах заранее
- Показывает общую картину трат на подписки
- Помогает планировать бюджет на месяц
- Ведет историю оплат

## Архитектура проекта

```
recur_bot/
├── node.js                    # Основной файл бота с командами
├── db.js                      # Подключение к PostgreSQL
├── reminderScheduler.js       # Планировщик напоминаний
├── reminderWorker.js          # Воркер для напоминаний
├── lib/                       # Бизнес-логика
│   ├── subscriptions.js       # CRUD операции с подписками
│   ├── users.js               # Работа с пользователями
│   ├── events.js              # Логирование событий (оплаты, пропуски)
│   ├── dates.js               # Парсинг и форматирование дат
│   ├── format.js              # Форматирование валют и текста
│   └── reminderLog.js         # Дедупликация напоминаний
├── webapp/                    # React фронтенд (Telegram Mini App)
└── docs/                      # Документация
```

## Технологический стек

### Backend
- **Node.js** (ESM modules)
- **Grammy** - фреймворк для Telegram ботов
- **@grammyjs/conversations** - диалоговые флоу (conversation flows)
- **PostgreSQL** - база данных
- **pg** - клиент для PostgreSQL
- **Luxon** - работа с датами и часовыми поясами
- **dotenv** - переменные окружения

### Frontend (webapp)
- **React** + **TypeScript**
- **Tailwind CSS**
- **Vite** - сборщик

## База данных

### Таблицы

#### `users`
Хранит информацию о пользователях бота:
- `user_id` - Telegram ID пользователя
- `tz` - часовой пояс (по умолчанию Europe/Moscow)
- `notify_hour` - час для напоминаний (по умолчанию 16:00)
- `default_reminders` - JSONB массив напоминаний ["T-3", "T-1", "T0"]

#### `subscriptions`
Подписки пользователей:
- `id` - первичный ключ
- `user_id` - владелец подписки
- `name` - название подписки
- `amount` - стоимость (numeric)
- `currency` - валюта (RUB, USD, EUR, KZT, BYN)
- `period` - периодичность (monthly, yearly)
- `next_due` - дата следующего списания
- `reminders` - JSONB массив напоминаний для этой подписки
- `notes` - заметки (опционально)

#### `subscription_events`
История событий по подпискам:
- `id` - первичный ключ
- `subscription_id` - ссылка на подписку
- `event_date` - дата события
- `status` - статус (paid, skipped)

#### `reminder_log`
Дедупликация напоминаний (чтобы не слать дубли):
- `reminder_key` - уникальный ключ напоминания
- `sent_at` - когда отправлено
- TTL для автоочистки старых записей

## Основной функционал

### Команды бота

#### Управление подписками
- `/add` - добавить новую подписку
  - Conversation flow: название → валюта → стоимость → дата → периодичность
  - Проверка на дубли по имени и дате
  - Валидация дат (не принимает прошлые даты)

- `/edit` - редактировать подписку
  - Выбор подписки из списка
  - Редактирование: название, стоимость, дата, периодичность

- `/delete` - удалить подписку

- `/pay` - отметить оплату вручную
  - Полезно, если дата в боте устарела
  - Автоматически сдвигает next_due на следующий период

#### Обзор и отчеты
- `/list` - все подписки с суммами
  - Группировка по периодичности (ежемесячные/ежегодные)
  - Показывает следующую дату списания
  - Итоги по валютам
  - Автоматическая синхронизация дат на основе истории оплат

- `/upcoming` - списания на 7 дней вперед
  - Группировка по датам
  - Фильтрация уже оплаченных (проверка за последние 60 дней)
  - Итоговая сумма по валютам

- `/month` - отчет по текущему месяцу
  - Раздел "Ждут оплаты"
  - Раздел "Уже оплатил"
  - Остаток на месяц

#### Напоминания
- `/reminders` - управление напоминаниями
  - Toggle кнопки для T-3, T-2, T-1
  - Изменение времени напоминаний (0-23 часа)
  - Настройки применяются ко всем подпискам пользователя

#### Служебное
- `/start` - онбординг и список команд
- `/dbstatus` - проверка подключения к базе
- `/timezone` - (планируется) изменение часового пояса
- `/export` - (планируется) экспорт данных в CSV

### Система напоминаний

Реализована в `reminderScheduler.js`, работает каждую минуту:

#### 1. Еженедельный дайджест (понедельник)
- Отправляется в `notify_hour` по понедельникам
- Список всех подписок на неделю вперед
- Итоговая сумма по валютам

#### 2. Предварительные напоминания (T-N)
- За N дней до списания (настраивается: T-3, T-2, T-1)
- Отправляются в `notify_hour` пользователя
- Формат: "Через 3 дня спишется: Netflix — 500 RUB (пт, 15 дек)"

#### 3. Утреннее напоминание (T0)
- В день списания в `notify_hour`
- Формат: "Сегодня спишется: Netflix — 500 RUB"

#### 4. Вечерняя проверка (20:00)
- Напоминание в 20:00 по местному времени
- Интерактивные кнопки:
  - **Оплатил** - логирует оплату, сдвигает дату на следующий период
  - **Отложить** - п��реносит на N дней (1, 2, 3, 7 или свое число)
  - **Пропустить цикл** - логирует пропуск, сдвигает на следующий период

#### Дедупликация
Использует `reminder_log` с уникальными ключами вида:
```
{userId}|{subscriptionId}|{type}|{dateKey}
```
Это предотвращает повторную отправку при перезапуске бота.

## Конфигурация (.env)

```env
BOT_TOKEN=your_telegram_bot_token
DATABASE_URL=postgresql://username:password@hostname:5432/database?sslmode=require
DEFAULT_TZ=Europe/Moscow
DEFAULT_NOTIFY_HOUR=16
DEFAULT_REMINDERS=T-3,T-1,T0
ENABLE_REMINDER_SCHEDULER=true
ALLOW_SELF_SIGNED=0
```

## Особенности реализации

### Работа с датами
- Используем Luxon для часовых поясов
- Все даты в БД хранятся в UTC (ISO format)
- Конвертация в местное время пользователя для отображения
- Поддержка парсинга дат в формате "12.10" или "12.10.2024"

### Валюты
Поддерживаются: RUB, USD, EUR, KZT, BYN

### Session management
- Grammy session для хранения состояний редактирования
- `ctx.session.edit` - состояние редактирования подписки
- `ctx.session.pay` - состояние отметки оплаты
- `ctx.session.pendingSnooze` - состояние отложения напоминания
- `ctx.session.reminderTime` - состояние изменения времени

### Conversation flows
Используем @grammyjs/conversations для:
- Добавления подписки (`addSubscriptionConversation`)
- Удаления подписки (`deleteSubscriptionConversation`)

### Автоматическая синхронизация дат
В команде `/list` происходит проверка:
- Если есть event 'paid' позже или равный `next_due`
- Автоматически накручиваем `next_due` на следующий период
- Это предотвращает устаревание дат при ручных оплатах

## Планы развития

### В разработке
- [ ] Изменение часового пояса через бот
- [ ] Экспорт данных в CSV
- [ ] Пауза подписки (временная заморозка)
- [ ] Telegram Mini App (webapp уже заложен)

### Идеи
- [ ] Статистика трат по месяцам
- [ ] Категории подписок
- [ ] Мультивалютная аналитика
- [ ] Уведомления о росте трат
- [ ] Интеграция с банками (автоматическое отслеживание)

## Деплой

Документация по деплою: [docs/DEPLOYMENT.md](docs/DEPLOYMENT.md)

Основные способы:
- PM2 (для production)
- Systemd service
- Docker (планируется)

## Автор

@hanumatori

---

**Последнее обновление:** 2026-01-04
